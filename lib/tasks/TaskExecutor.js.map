{"version":3,"file":"TaskExecutor.js","sourceRoot":"","sources":["../../src/tasks/TaskExecutor.ts"],"names":[],"mappings":"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","sourcesContent":["'use babel'\nimport { ProjectManager } from '../DEWorkbench/ProjectManager';\nimport { Cordova , CordovaProjectInfo} from '../cordova/Cordova';\nimport { CordovaTaskConfiguration } from '../cordova/CordovaTasks'\nimport { PlatformServer, PlatformServerImpl, PlatformServerConfig } from '../services/remote/PlatformServer'\nimport { TaskUtils } from './TaskUtils'\nimport { Logger }  from '../logger/Logger'\nimport { ScriptExecutor } from './ScriptExecutor'\n\nexport class TaskExecutor{\n  private currentTask:CordovaTaskConfiguration;\n  private platformServer:PlatformServer = null;\n  private scriptExecutor:ScriptExecutor = null;\n  private cordova:Cordova\n  constructor(){\n      this.cordova=ProjectManager.getInstance().cordova;\n  }\n  public async executeTask(taskConfig:CordovaTaskConfiguration,project:CordovaProjectInfo):Promise<any>{\n    if(this.isBusy()){\n      throw new Error(\"TaskExecutor is busy\");\n    }\n    await this.scheduleNodeScripts(taskConfig,project);\n    this.currentTask = taskConfig;\n    Logger.getInstance().debug('schedule node tasks');\n    try{\n      switch(this.currentTask.taskType){\n        case \"prepare\":\n            await this.executePrepare(project);\n            this.currentTask = null;\n        break;\n        case \"build\":\n            await this.executeBuild(project);\n            this.currentTask = null\n        break;\n        case \"run\":\n            await this.executeRun(project);\n            this.currentTask = null\n        case \"buildRun\":\n            await this.executeBuild(project);\n            // TODO publish progress\n            await this.executeRun(project)\n            this.currentTask = null\n        break;\n      }\n    }catch(err){\n      this.currentTask = null;\n      throw err;\n    }\n  }\n  public async executeTaskChain(taskChain:Array<CordovaTaskConfiguration>,project:CordovaProjectInfo){\n    for(let task of taskChain){\n      await this.executeTask(task,project);\n    }\n  }\n  isBusy():boolean{\n    return this.currentTask != null;\n  }\n  async executeBuild(project:CordovaProjectInfo){\n    let platform= this.currentTask.selectedPlatform ?this.currentTask.selectedPlatform.name : null;\n    return this.cordova.buildProject(project.path, platform ,{});\n  }\n\n  async executeRun(project:CordovaProjectInfo){\n    this.startPlatformServer(project);\n    let platform = this.currentTask.selectedPlatform ?this.currentTask.selectedPlatform.name : null;\n    return this.cordova.runProject(project.path, platform ,null,{});\n  }\n\n  async executePrepare(project:CordovaProjectInfo){\n    let platform = this.currentTask.selectedPlatform ?this.currentTask.selectedPlatform.name : null;\n    return this.cordova.prepareProject(project.path,platform);\n  }\n\n  private async startPlatformServer(project:CordovaProjectInfo){\n    let platform = this.currentTask.selectedPlatform;\n    if(!platform){\n      Logger.getInstance().warn(\"No platform detected: server not started\");\n      return Promise.resolve();\n    }\n    if(this.isPlatformServerRunning()){\n      Logger.getInstance().warn(\"Platform server already started\");\n      return Promise.resolve();\n    }\n    Logger.getInstance().info(`Platform Server for ${platform} starting`);\n    const srvConf:PlatformServerConfig = TaskUtils.createPlatformServerConfig(this.currentTask,project);\n    if(!srvConf){\n      Logger.getInstance().error(\"Server configuration build fail\");\n      return Promise.resolve();\n    }\n    await this.cordova.prepareProjectWithBrowserPatch(project.path);\n    this.platformServer = PlatformServerImpl.createNew();\n    this.platformServer.start(srvConf);\n  }\n\n  stopServer(){\n    if(this.platformServer){\n      this.platformServer.stop().then(() => {\n          Logger.getInstance().info(\"Server stop done\");\n      },() => {\n        Logger.getInstance().error(\"Server stop fail\");\n      });\n    }\n  }\n\n  stop(){\n    if(this.scriptExecutor){\n      this.scriptExecutor.stop();\n    }\n    this.cordova.stopExecutor();\n    this.stopServer();\n  }\n\n  isPlatformServerRunning():boolean{\n    return this.platformServer && this.platformServer.isRunning();\n  }\n\n\n  private async scheduleNodeScripts(taskConfig:CordovaTaskConfiguration,project:CordovaProjectInfo){\n    if(!taskConfig.nodeTasks || !(taskConfig.nodeTasks.length > 0)){\n      Logger.getInstance().debug('No script defined');\n      return Promise.resolve();\n    }\n    Logger.getInstance().debug('Begin npm script run');\n    this.scriptExecutor = new ScriptExecutor();\n    let res= await this.scriptExecutor.runNpmScripts(taskConfig.nodeTasks,project.path);\n    Logger.getInstance().debug('End npm script run');\n    return res;\n  }\n\n}\n"]}